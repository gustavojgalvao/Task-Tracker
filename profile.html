<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ascend — Perfil</title>
  <meta name="description" content="Perfil público Ascend — Constância visível." />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#6366f1" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Ascend" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/pages/habits.css" />
</head>

<body>

  <nav class="nav">
    <div class="nav-inner">
      <a href="index.html" class="nav-logo">
        <div class="nav-logo-icon"><i class="fa-solid fa-chevron-up"></i></div>
        <span>Ascend</span>
      </a>
      <div class="nav-links" id="nav-auth-links">
        <a href="auth.html" class="btn btn-ghost btn-sm">Entrar</a>
        <a href="auth.html?tab=signup" class="btn btn-primary btn-sm">Criar conta</a>
      </div>
    </div>
  </nav>

  <!-- Mobile-only header for profile public page -->
  <div class="profile-mobile-header">
    <a href="index.html" class="profile-mobile-back">
      <div class="nav-logo-icon" style="width:28px;height:28px;font-size:0.85rem;"><i
          class="fa-solid fa-chevron-up"></i></div>
      <span style="font-family:var(--font-display);font-weight:800;font-size:1.1rem;">Ascend</span>
    </a>
    <a href="auth.html?tab=signup" class="btn btn-primary btn-sm">Criar conta</a>
  </div>

  <div class="page-wrapper profile-page">
    <div class="container" id="profile-content">
      <div class="empty-state">
        <div class="spinner" style="width:32px;height:32px;"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/supabase.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/logs.js"></script>
  <script src="js/habits.js"></script>
  <script src="js/score.js"></script>
  <script src="js/streak.js"></script>
  <script src="js/identity.js"></script>
  <script src="js/heatmap.js"></script>
  <script>
    async function init() {
      const session = await Auth.getSession();
      if (session) {
        document.getElementById('nav-auth-links').innerHTML =
          `<a href="dashboard.html" class="btn btn-primary btn-sm">Dashboard</a>`;
      }

      const slug = new URLSearchParams(location.search).get('u');
      if (!slug) { renderNotFound(); return; }

      try {
        const profile = await Identity.getPublicProfile(slug);
        if (!profile) { renderNotFound(); return; }
        await renderProfile(profile);
      } catch (err) {
        renderNotFound();
      }
    }

    async function renderProfile(profile) {
      const { data: logs } = await window.supabaseClient
        .from('habit_logs')
        .select('*')
        .eq('user_id', profile.id)
        .gte('date', new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0])
        .order('date', { ascending: true });

      const { data: habits } = await window.supabaseClient
        .from('habits')
        .select('*')
        .eq('user_id', profile.id)
        .eq('is_active', true);

      const allLogs = logs || [];
      const allHabits = habits || [];

      const scoreMap = Logs.buildScoreMap(allLogs);
      const totalScore = allLogs.reduce((s, l) => s + (l.score_earned || 0), 0);
      const globalStreak = Streak.calcGlobalStreak(allLogs, allHabits);
      const activeDays = allLogs.filter(l => l.completed).length;

      const name = profile.username || 'Ascender';
      const initials = name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();

      document.title = `${name} — Ascend`;

      document.getElementById('profile-content').innerHTML = `
        <div class="profile-hero animate-slide-up">
          <div class="profile-avatar">${initials}</div>
          <div class="profile-name">${name}</div>
          ${profile.future_version ? `<div class="profile-version">"${profile.future_version}"</div>` : ''}
          <div class="profile-stats-row">
            <div class="profile-stat">
              <div class="profile-stat-value gradient-text-gold">
                <i class="fa-solid fa-fire"></i> ${globalStreak}
              </div>
              <div class="profile-stat-label">Streak global</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-value gradient-text">${totalScore}</div>
              <div class="profile-stat-label">Score total</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-value">${allHabits.length}</div>
              <div class="profile-stat-label">Hábitos ativos</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-value">${activeDays}</div>
              <div class="profile-stat-label">Dias com registro</div>
            </div>
          </div>
        </div>

        <div class="profile-heatmap-section animate-slide-up delay-200">
          <div class="card" style="padding:32px;overflow-x:auto;">
            <div class="card-header">
              <span class="card-title">Heatmap Anual ${new Date().getFullYear()}</span>
              <span class="badge badge-green">Constância real</span>
            </div>
            <div id="public-heatmap"></div>
          </div>
        </div>

        <div style="text-align:center;margin-top:32px;padding:24px;border-top:1px solid var(--border);">
          <p style="color:var(--text-muted);margin-bottom:16px;">Monitore sua própria constância</p>
          <a href="auth.html?tab=signup" class="btn btn-primary btn-lg">
            <i class="fa-solid fa-chevron-up"></i> Criar conta grátis
          </a>
        </div>
      `;

      Heatmap.render(document.getElementById('public-heatmap'), scoreMap, new Date().getFullYear());
    }

    function renderNotFound() {
      document.getElementById('profile-content').innerHTML = `
        <div class="profile-not-public animate-fade-in">
          <div style="font-size:3rem;margin-bottom:24px;color:var(--text-muted);">
            <i class="fa-solid fa-lock"></i>
          </div>
          <h2>Perfil não encontrado</h2>
          <p style="color:var(--text-muted);margin:16px 0 32px;">
            Este perfil não existe ou não é público.
          </p>
          <a href="index.html" class="btn btn-primary">
            <i class="fa-solid fa-arrow-left"></i> Voltar ao início
          </a>
        </div>`;
    }

    init();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>

</html>