<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ascend — Gerenciar Hábitos</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#6366f1" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Ascend" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/pages/habits.css" />
</head>

<body>

    <nav class="nav">
        <div class="nav-inner">
            <a href="dashboard.html" class="nav-logo">
                <div class="nav-logo-icon"><i class="fa-solid fa-chevron-up"></i></div>
                <span>Ascend</span>
            </a>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="habits.html" class="nav-link active">Hábitos</a>
                <a href="agenda.html" class="nav-link">Agenda</a>
                <a href="analytics.html" class="nav-link">Análises</a>
                <button class="btn btn-ghost btn-sm" onclick="Auth.signOut()" style="margin-left:8px;">Sair</button>
            </div>
        </div>
    </nav>



    <div class="page-wrapper habits-page">
        <div class="container">

            <div class="habits-header animate-slide-up">
                <div class="habits-header-left">
                    <h1>Seus Hábitos</h1>
                    <p class="habits-header-sub">Gerencie, ajuste e evolua seus hábitos.</p>
                </div>
                <button class="btn btn-primary" onclick="openModal()"><i class="fa-solid fa-plus"></i> Novo
                    hábito</button>
            </div>

            <div class="habits-full-list animate-slide-up delay-100" id="habits-full-list">
                <div class="empty-state">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Paused habits section -->
            <div id="paused-section" style="display:none;margin-top:32px;">
                <div
                    style="font-size:0.8rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:12px;">
                    <i class="fa-solid fa-pause-circle"></i> Suspensos
                </div>
                <div class="habits-full-list" id="paused-habits-list"></div>
            </div>

        </div>
    </div>

    <!-- Habit Modal -->
    <div class="modal-overlay" id="habit-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Novo Hábito</h3>
                <button class="modal-close" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <form class="habit-form" onsubmit="event.preventDefault(); saveHabit();">
                <input type="hidden" id="habit-id" />

                <!-- Name + Icon -->
                <div class="habit-form-row">
                    <div class="form-group">
                        <label class="form-label">Nome<span>*</span></label>
                        <input class="form-input" type="text" id="habit-name" placeholder="Ex: Academia, Leitura..."
                            required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ícone</label>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                            <button type="button" id="selected-icon-btn" class="btn btn-ghost"
                                style="font-size:1.1rem;width:44px;height:44px;padding:0;" onclick="toggleIconPicker()">
                                <i class="fa-solid fa-bolt" id="selected-icon-preview"></i>
                            </button>
                            <div id="icon-picker" class="icon-grid" style="display:none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Weight (slider) -->
                <div class="form-group">
                    <label class="form-label">Peso (impacto no score)</label>
                    <input class="form-range" type="range" id="habit-weight" min="1" max="5" value="1"
                        oninput="updateWeightDisplay(this.value)" />
                    <div class="weight-display">
                        <span id="weight-label">Leve</span>
                        <span class="weight-points"><span id="weight-val">1</span> ponto por dia</span>
                    </div>
                </div>

                <!-- Color -->
                <div class="form-group">
                    <label class="form-label">Cor</label>
                    <div class="color-row" id="color-row"></div>
                </div>

                <!-- Frequency -->
                <div class="form-group">
                    <label class="form-label">Frequência</label>
                    <select class="form-select" id="habit-frequency" onchange="onFrequencyChange(this.value)">
                        <option value="daily">Todo dia</option>
                        <option value="weekly">Dias específicos da semana</option>
                        <option value="cycle">A cada N dias (ciclo)</option>
                    </select>
                </div>

                <!-- Days of week -->
                <div class="form-group" id="days-group" style="display:none;">
                    <label class="form-label">Dias da semana</label>
                    <div class="days-selector" id="days-selector">
                        <button type="button" class="day-btn" data-day="0">Dom</button>
                        <button type="button" class="day-btn" data-day="1">Seg</button>
                        <button type="button" class="day-btn" data-day="2">Ter</button>
                        <button type="button" class="day-btn" data-day="3">Qua</button>
                        <button type="button" class="day-btn" data-day="4">Qui</button>
                        <button type="button" class="day-btn" data-day="5">Sex</button>
                        <button type="button" class="day-btn" data-day="6">Sáb</button>
                    </div>
                </div>

                <!-- Cycle options -->
                <div class="form-group" id="cycle-group" style="display:none;">
                    <label class="form-label">Configuração do ciclo</label>
                    <!-- Cycle type radios -->
                    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px;">
                        <label style="cursor:pointer;display:flex;align-items:flex-start;gap:8px;">
                            <input type="radio" name="cycle-type" id="cycle-type-active" value="active" checked
                                onchange="onCycleTypeChange('active')" style="margin-top:3px;" />
                            <span>
                                <span style="font-size:0.85rem;font-weight:500;">Fazer a cada N dias</span>
                                <p class="settings-sub" style="margin:2px 0 0;">Hábito aparece 1x a cada N dias</p>
                            </span>
                        </label>
                        <label style="cursor:pointer;display:flex;align-items:flex-start;gap:8px;">
                            <input type="radio" name="cycle-type" id="cycle-type-rest" value="rest"
                                onchange="onCycleTypeChange('rest')" style="margin-top:3px;" />
                            <span>
                                <span style="font-size:0.85rem;font-weight:500;">Descansar a cada N dias</span>
                                <p class="settings-sub" style="margin:2px 0 0;">Aparece todo dia, exceto a cada N dias
                                </p>
                            </span>
                        </label>
                        <label style="cursor:pointer;display:flex;align-items:flex-start;gap:8px;">
                            <input type="radio" name="cycle-type" id="cycle-type-pattern" value="pattern"
                                onchange="onCycleTypeChange('pattern')" style="margin-top:3px;" />
                            <span>
                                <span style="font-size:0.85rem;font-weight:500;">Sequência progressiva de
                                    descansos</span>
                                <p class="settings-sub" style="margin:2px 0 0;">Ex: 7, 9, 5 → faz 7 dias, descansa, faz
                                    9, descansa, faz 5, descansa, repete</p>
                            </span>
                        </label>
                    </div>

                    <!-- Simple N-days input (active / rest) -->
                    <div id="cycle-simple-inputs" class="habit-form-row">
                        <div class="form-group" style="margin:0">
                            <label class="form-label" style="font-size:0.8rem;" id="cycle-days-label">Intervalo
                                (dias)</label>
                            <input class="form-input" type="number" id="habit-cycle-days" min="2" max="365" value="7"
                                placeholder="Ex: 7" />
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label" style="font-size:0.8rem;">Data de início</label>
                            <input class="form-input" type="date" id="habit-cycle-start" />
                        </div>
                    </div>

                    <!-- Pattern input (progressive) -->
                    <div id="cycle-pattern-inputs" style="display:none;">
                        <label class="form-label" style="font-size:0.8rem;">Sequência de dias ativos (separados por
                            vírgula)</label>
                        <input class="form-input" type="text" id="habit-cycle-pattern" placeholder="Ex: 7, 9, 5"
                            style="margin-top:6px;" />
                        <p class="settings-sub" style="margin-top:6px;">Informe quantos dias seguidos você faz o hábito
                            antes de cada descanso.</p>
                        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;">
                            <button type="button" class="badge badge-accent" onclick="setPattern('7, 7')">7 · 7</button>
                            <button type="button" class="badge badge-accent" onclick="setPattern('5, 7, 5')">5 · 7 ·
                                5</button>
                            <button type="button" class="badge badge-accent" onclick="setPattern('7, 9, 5')">7 · 9 ·
                                5</button>
                            <button type="button" class="badge badge-accent" onclick="setPattern('6, 8, 6, 10')">6 · 8 ·
                                6 · 10</button>
                        </div>
                        <div class="form-group" style="margin-top:12px;">
                            <label class="form-label" style="font-size:0.8rem;">Data de início</label>
                            <input class="form-input" type="date" id="habit-cycle-pattern-start" />
                        </div>
                    </div>
                </div>

                <!-- Meta / Goal -->
                <div class="form-group">
                    <div class="toggle-wrapper">
                        <span class="form-label" style="margin:0">Meta quantitativa</span>
                        <label class="toggle">
                            <input type="checkbox" id="habit-goal-toggle" onchange="onGoalToggle(this.checked)" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <p class="settings-sub" style="margin-top:4px;">Ex: beber 2 litros, ler 30 páginas</p>
                </div>
                <div class="form-group" id="goal-group" style="display:none;">
                    <div class="habit-form-row">
                        <div class="form-group" style="margin:0">
                            <label class="form-label" style="font-size:0.8rem;">Quantidade alvo</label>
                            <input class="form-input" type="number" id="habit-goal-value" min="1" placeholder="Ex: 2" />
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label" style="font-size:0.8rem;">Unidade</label>
                            <input class="form-input" type="text" id="habit-goal-unit"
                                placeholder="Ex: litros, páginas, km" />
                        </div>
                    </div>
                    <div class="goal-unit-chips" style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;">
                        <button type="button" class="badge badge-accent" onclick="setGoalUnit('litros')">litros</button>
                        <button type="button" class="badge badge-accent" onclick="setGoalUnit('ml')">ml</button>
                        <button type="button" class="badge badge-accent"
                            onclick="setGoalUnit('páginas')">páginas</button>
                        <button type="button" class="badge badge-accent" onclick="setGoalUnit('km')">km</button>
                        <button type="button" class="badge badge-accent" onclick="setGoalUnit('min')">min</button>
                        <button type="button" class="badge badge-accent" onclick="setGoalUnit('horas')">horas</button>
                    </div>
                </div>

                <!-- Ideal time + Strict mode -->
                <div class="habit-form-row">
                    <div class="form-group">
                        <label class="form-label">Horário ideal</label>
                        <input class="form-input" type="time" id="habit-time" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Modo rigoroso</label>
                        <div class="toggle-wrapper" style="margin-top:12px;">
                            <span class="settings-sub">Perde 50% fora do horário</span>
                            <label class="toggle">
                                <input type="checkbox" id="habit-strict" />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="btn-save-habit" style="width:100%;margin-top:8px;">
                    Salvar hábito
                </button>
            </form>
        </div>
    </div>

    <!-- Delete confirm modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal" style="max-width:380px;">
            <div class="modal-header">
                <h3 class="modal-title">Excluir hábito?</h3>
                <button class="modal-close" onclick="closeDeleteModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <p style="color:var(--text-secondary);margin-bottom:24px;">
                O hábito <strong id="delete-habit-name"></strong> e seus dados históricos serão removidos. Esta ação não
                pode ser desfeita.
            </p>
            <div style="display:flex;gap:12px;">
                <button class="btn btn-ghost" style="flex:1;" onclick="closeDeleteModal()">Cancelar</button>
                <button class="btn btn-danger" style="flex:1;" id="btn-confirm-delete" onclick="confirmDelete()">
                    <i class="fa-solid fa-trash"></i> Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="bottom-nav-item">
            <i class="fa-solid fa-gauge"></i>
            <span>Dashboard</span>
        </a>
        <a href="habits.html" class="bottom-nav-item active">
            <i class="fa-solid fa-bolt"></i>
            <span>Hábitos</span>
        </a>
        <a href="agenda.html" class="bottom-nav-item">
            <i class="fa-solid fa-calendar-check"></i>
            <span>Agenda</span>
        </a>
        <a href="analytics.html" class="bottom-nav-item">
            <i class="fa-solid fa-chart-bar"></i>
            <span>Análises</span>
        </a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/router.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/habits.js"></script>
    <script>
        let allHabits = [];
        let selectedIcon = 'fa-solid fa-bolt';
        let selectedColor = '#6366f1';
        let selectedDays = [];
        let deleteTargetId = null;

        const WEIGHT_LABELS = ['', 'Leve', 'Moderado', 'Importante', 'Alto', 'Crítico'];

        function renderIcon(icon) {
            if (!icon) return '<i class="fa-solid fa-bolt"></i>';
            if (icon.startsWith('fa-')) return `<i class="${icon}"></i>`;
            return icon; // legacy emoji fallback
        }

        async function init() {
            const ok = await Router.init();
            if (!ok) return;
            buildIconPicker();
            buildColorPicker();
            setupDayButtons();
            await loadHabits();
        }

        async function loadHabits() {
            allHabits = await Habits.getAllIncludingPaused();
            renderHabits();
        }

        function buildHabitCard(h, paused = false) {
            let freqLabel;
            if (h.frequency === 'daily') freqLabel = 'Todo dia';
            else if (h.frequency === 'cycle') freqLabel = `A cada ${h.cycle_days || '?'} dias`;
            else freqLabel = (h.days_of_week || []).map(d => ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'][d]).join(', ');

            const dots = Array.from({ length: 5 }, (_, i) =>
                `<div class="habit-weight-dot ${i < h.weight ? 'active' : ''}"></div>`
            ).join('');

            const goalTag = h.goal_value
                ? `<span class="habit-manage-tag"><i class="fa-solid fa-bullseye"></i> Meta: ${h.goal_value} ${h.goal_unit || ''}</span>` : '';

            const escapedName = h.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const iconColor = paused ? 'var(--text-muted)' : h.color;

            const pauseBtn = paused
                ? `<button class="btn btn-icon" style="color:var(--green)" onclick="resumeHabit('${h.id}')" title="Reativar"><i class="fa-solid fa-play"></i></button>`
                : `<button class="btn btn-icon" onclick="pauseHabit('${h.id}', '${escapedName}')" title="Suspender"><i class="fa-solid fa-pause"></i></button>`;

            return `
          <div class="habit-manage-item animate-fade-in ${paused ? 'habit-paused' : ''}" id="hm-${h.id}">
            <div class="habit-icon" style="background:${h.color}22;color:${iconColor};font-size:1.2rem;width:48px;height:48px;">
              ${renderIcon(h.icon)}
            </div>
            <div class="habit-manage-info">
              <div class="habit-manage-name">${h.name}</div>
              <div class="habit-manage-meta">
                <span class="habit-manage-tag">
                  <div class="habit-weight">${dots}</div>
                  ${h.weight} pt${h.weight > 1 ? 's' : ''}
                </span>
                <span class="habit-manage-tag"><i class="fa-regular fa-calendar"></i> ${freqLabel}</span>
                ${h.ideal_time ? `<span class="habit-manage-tag"><i class="fa-regular fa-clock"></i> ${UI.formatTime(h.ideal_time)}</span>` : ''}
                ${h.strict_mode ? `<span class="habit-manage-tag"><i class="fa-solid fa-shield-halved"></i> Rigoroso</span>` : ''}
                ${goalTag}
              </div>
            </div>
            <div class="habit-manage-actions">
              ${!paused ? `<button class="btn btn-icon" onclick="openModal('${h.id}')" title="Editar"><i class="fa-solid fa-pen"></i></button>` : ''}
              ${pauseBtn}
              <button class="btn btn-icon" style="color:var(--red,#ef4444)" onclick="openDeleteModal('${h.id}', '${escapedName}')" title="Excluir"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>`;
        }

        function renderHabits() {
            const container = document.getElementById('habits-full-list');
            const active = allHabits.filter(h => !h.is_paused);
            const paused = allHabits.filter(h => h.is_paused);

            if (allHabits.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon"><i class="fa-solid fa-bolt fa-2x"></i></div>
            <div class="empty-title">Nenhum hábito ainda</div>
            <p class="empty-desc">Crie seu primeiro hábito e comece a medir sua consistência.</p>
            <button class="btn btn-primary" onclick="openModal()"><i class="fa-solid fa-plus"></i> Criar hábito</button>
          </div>`;
                document.getElementById('paused-section').style.display = 'none';
                return;
            }

            container.innerHTML = active.length > 0
                ? active.map(h => buildHabitCard(h, false)).join('')
                : `<div style="padding:20px;color:var(--text-muted);text-align:center;">Todos os hábitos estão suspensos.</div>`;

            const pausedSection = document.getElementById('paused-section');
            const pausedList = document.getElementById('paused-habits-list');
            if (paused.length > 0) {
                pausedList.innerHTML = paused.map(h => buildHabitCard(h, true)).join('');
                pausedSection.style.display = 'block';
            } else {
                pausedSection.style.display = 'none';
            }
        }

        function openModal(habitId = null) {
            document.getElementById('modal-title').textContent = habitId ? 'Editar Hábito' : 'Novo Hábito';
            document.getElementById('habit-id').value = habitId || '';

            if (habitId) {
                const h = allHabits.find(h => h.id === habitId);
                if (!h) return;
                document.getElementById('habit-name').value = h.name;
                document.getElementById('habit-weight').value = h.weight;
                updateWeightDisplay(h.weight);
                document.getElementById('habit-time').value = h.ideal_time || '';
                document.getElementById('habit-strict').checked = h.strict_mode;
                document.getElementById('habit-frequency').value = h.frequency;
                onFrequencyChange(h.frequency);
                selectedIcon = h.icon;
                selectedColor = h.color;
                updateIconPreview();
                selectedDays = h.days_of_week || [];
                updateDayButtons();
                updateColorPicker();
                // Cycle
                const ctype = h.cycle_type || 'active';
                document.querySelector(`input[name="cycle-type"][value="${ctype}"]`).checked = true;
                onCycleTypeChange(ctype);
                document.getElementById('habit-cycle-days').value = h.cycle_days || 7;
                document.getElementById('habit-cycle-start').value = h.cycle_start || UI.todayStr();
                document.getElementById('habit-cycle-pattern').value = h.cycle_pattern || '';
                document.getElementById('habit-cycle-pattern-start').value = h.cycle_start || UI.todayStr();
                // Goal
                const hasGoal = !!(h.goal_value);
                document.getElementById('habit-goal-toggle').checked = hasGoal;
                document.getElementById('habit-goal-value').value = h.goal_value || '';
                document.getElementById('habit-goal-unit').value = h.goal_unit || '';
                onGoalToggle(hasGoal);
            } else {
                document.getElementById('habit-name').value = '';
                document.getElementById('habit-weight').value = 1;
                updateWeightDisplay(1);
                document.getElementById('habit-time').value = '';
                document.getElementById('habit-strict').checked = false;
                document.getElementById('habit-frequency').value = 'daily';
                onFrequencyChange('daily');
                selectedIcon = 'fa-solid fa-bolt';
                selectedColor = '#6366f1';
                updateIconPreview();
                selectedDays = [];
                updateDayButtons();
                updateColorPicker();
                // Cycle defaults
                document.getElementById('cycle-type-active').checked = true;
                onCycleTypeChange('active');
                document.getElementById('habit-cycle-days').value = 7;
                document.getElementById('habit-cycle-start').value = UI.todayStr();
                document.getElementById('habit-cycle-pattern').value = '';
                document.getElementById('habit-cycle-pattern-start').value = UI.todayStr();
                // Goal defaults
                document.getElementById('habit-goal-toggle').checked = false;
                document.getElementById('habit-goal-value').value = '';
                document.getElementById('habit-goal-unit').value = '';
                onGoalToggle(false);
            }
            document.getElementById('habit-modal').classList.add('open');
        }

        function updateIconPreview() {
            document.getElementById('selected-icon-preview').className = selectedIcon;
        }

        function closeModal() {
            document.getElementById('habit-modal').classList.remove('open');
            document.getElementById('icon-picker').style.display = 'none';
        }

        async function saveHabit() {
            const btn = document.getElementById('btn-save-habit');
            const name = document.getElementById('habit-name').value.trim();
            if (!name) { UI.toast('Nome é obrigatório.', 'error'); return; }
            const frequency = document.getElementById('habit-frequency').value;
            if (frequency === 'weekly' && selectedDays.length === 0) {
                UI.toast('Selecione ao menos um dia da semana.', 'error'); return;
            }
            if (frequency === 'cycle') {
                const ctype = document.querySelector('input[name="cycle-type"]:checked')?.value || 'active';
                if (ctype !== 'pattern' && !document.getElementById('habit-cycle-days').value) {
                    UI.toast('Informe o número de dias do ciclo.', 'error'); return;
                }
                if (ctype === 'pattern' && !document.getElementById('habit-cycle-pattern').value.trim()) {
                    UI.toast('Informe a sequência de dias do ciclo.', 'error'); return;
                }
            }

            const hasGoal = document.getElementById('habit-goal-toggle').checked;
            const goalValue = hasGoal ? parseFloat(document.getElementById('habit-goal-value').value) : null;
            const goalUnit = hasGoal ? document.getElementById('habit-goal-unit').value.trim() : null;
            if (hasGoal && (!goalValue || goalValue <= 0)) {
                UI.toast('Informe a quantidade alvo da meta.', 'error'); return;
            }

            const cycleType = frequency === 'cycle' ? (document.querySelector('input[name="cycle-type"]:checked')?.value || 'active') : null;
            const isPattern = cycleType === 'pattern';

            const data = {
                name,
                weight: parseInt(document.getElementById('habit-weight').value),
                frequency,
                days_of_week: frequency === 'weekly' ? selectedDays : null,
                ideal_time: document.getElementById('habit-time').value || null,
                strict_mode: document.getElementById('habit-strict').checked,
                icon: selectedIcon,
                color: selectedColor,
                goal_value: goalValue,
                goal_unit: goalUnit,
                cycle_days: (frequency === 'cycle' && !isPattern) ? parseInt(document.getElementById('habit-cycle-days').value) : null,
                cycle_start: frequency === 'cycle' ? (
                    isPattern
                        ? (document.getElementById('habit-cycle-pattern-start').value || UI.todayStr())
                        : (document.getElementById('habit-cycle-start').value || UI.todayStr())
                ) : null,
                cycle_type: cycleType,
                cycle_pattern: (frequency === 'cycle' && isPattern)
                    ? document.getElementById('habit-cycle-pattern').value.trim()
                    : null,
            };
            const id = document.getElementById('habit-id').value;
            await UI.handleSubmit(btn, async () => {
                if (id) {
                    await Habits.update(id, data);
                    UI.toast('Hábito atualizado!', 'success');
                } else {
                    await Habits.create(data);
                    UI.toast('Hábito criado!', 'success');
                }
                closeModal();
                await loadHabits();
            });
        }

        async function pauseHabit(id, name) {
            await Habits.pause(id);
            UI.toast(`"${name}" suspenso.`, 'info');
            await loadHabits();
        }

        async function resumeHabit(id) {
            await Habits.resume(id);
            UI.toast('Hábito reativado!', 'success');
            await loadHabits();
        }

        function openDeleteModal(id, name) {
            deleteTargetId = id;
            document.getElementById('delete-habit-name').textContent = name;
            document.getElementById('delete-modal').classList.add('open');
        }

        function closeDeleteModal() {
            deleteTargetId = null;
            document.getElementById('delete-modal').classList.remove('open');
        }

        async function confirmDelete() {
            if (!deleteTargetId) return;
            const btn = document.getElementById('btn-confirm-delete');
            await UI.handleSubmit(btn, async () => {
                await Habits.remove(deleteTargetId);
                closeDeleteModal();
                UI.toast('Hábito removido.', 'info');
                await loadHabits();
            });
        }

        function updateWeightDisplay(val) {
            document.getElementById('weight-val').textContent = val;
            document.getElementById('weight-label').textContent = WEIGHT_LABELS[val] || '';
        }

        function onFrequencyChange(val) {
            document.getElementById('days-group').style.display = val === 'weekly' ? 'block' : 'none';
            document.getElementById('cycle-group').style.display = val === 'cycle' ? 'block' : 'none';
        }

        function onCycleTypeChange(type) {
            const simple = document.getElementById('cycle-simple-inputs');
            const pattern = document.getElementById('cycle-pattern-inputs');
            if (type === 'pattern') {
                simple.style.display = 'none';
                pattern.style.display = 'block';
            } else {
                simple.style.display = '';
                pattern.style.display = 'none';
            }
        }

        function setPattern(val) {
            document.getElementById('habit-cycle-pattern').value = val;
        }

        function onGoalToggle(enabled) {
            document.getElementById('goal-group').style.display = enabled ? 'block' : 'none';
        }

        function setGoalUnit(unit) {
            document.getElementById('habit-goal-unit').value = unit;
        }

        function setupDayButtons() {
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const day = parseInt(btn.dataset.day);
                    if (selectedDays.includes(day)) selectedDays = selectedDays.filter(d => d !== day);
                    else selectedDays.push(day);
                    updateDayButtons();
                });
            });
        }

        function updateDayButtons() {
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.toggle('selected', selectedDays.includes(parseInt(btn.dataset.day)));
            });
        }

        function buildIconPicker() {
            const grid = document.getElementById('icon-picker');
            grid.className = 'icon-grid';
            Habits.ICONS.forEach(iconClass => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'icon-btn';
                btn.innerHTML = `<i class="${iconClass}"></i>`;
                btn.onclick = () => {
                    selectedIcon = iconClass;
                    updateIconPreview();
                    document.querySelectorAll('#icon-picker .icon-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                };
                grid.appendChild(btn);
            });
        }

        function toggleIconPicker() {
            const picker = document.getElementById('icon-picker');
            picker.style.display = picker.style.display === 'none' ? 'grid' : 'none';
        }

        function buildColorPicker() {
            const row = document.getElementById('color-row');
            Habits.COLORS.forEach(color => {
                const swatch = document.createElement('button');
                swatch.type = 'button';
                swatch.className = 'color-swatch';
                swatch.style.background = color;
                swatch.dataset.color = color;
                swatch.onclick = () => { selectedColor = color; updateColorPicker(); };
                row.appendChild(swatch);
            });
        }

        function updateColorPicker() {
            document.querySelectorAll('.color-swatch').forEach(s => {
                s.classList.toggle('selected', s.dataset.color === selectedColor);
            });
        }

        document.getElementById('habit-modal').addEventListener('click', e => {
            if (e.target === e.currentTarget) closeModal();
        });
        document.getElementById('delete-modal').addEventListener('click', e => {
            if (e.target === e.currentTarget) closeDeleteModal();
        });



        init();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>

</html>